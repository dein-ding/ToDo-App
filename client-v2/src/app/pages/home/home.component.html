<app-sidebar-layout data-test-name="workspace-page">
    <!-- SIDEBAR HEADER -->
    <ng-container sidebarHeader>
        <div class="flex flex-col items-start gap-1 px-2 pb-2 pt-0.5 text-tinted-300" cdkMenu>
            <button
                cdkMenuItem
                class="menu-item | w-full text-left"
                appTooltip="Search for tasks and lists"
                [tooltipOptions]="{ preferredPosition: 'right' }"
            >
                <app-icon iconClass="fas fa-search"></app-icon> Search
            </button>
            <button
                cdkMenuItem
                class="menu-item | w-full text-left"
                appTooltip="Import one or more lists"
                [tooltipOptions]="{ preferredPosition: 'right' }"
            >
                <app-icon iconClass="fas fa-file-import"></app-icon> Import
            </button>
            <button
                cdkMenuItem
                class="menu-item | w-full text-left"
                appTooltip="Deleted content stays here for 30 days"
                [tooltipOptions]="{ preferredPosition: 'right' }"
            >
                <app-icon iconClass="fas fa-trash"></app-icon> Garbage
            </button>
            <button
                cdkMenuItem
                class="menu-item | w-full text-left"
                routerLink="/settings"
                appTooltip="The app settings"
                [tooltipOptions]="{ preferredPosition: 'right' }"
                data-test-name="settings-link"
            >
                <app-icon iconClass="fas fa-cog"></app-icon> Settings
            </button>
        </div>
    </ng-container>

    <!-- SIDEBAR CONTENT -->
    <ng-container sidebarContent>
        <p class="px-3 text-sm text-tinted-400">Tasklists</p>

        <cdk-tree [dataSource]="dataSource" [treeControl]="treeControl" class="tree-container | flex flex-col px-2">
            <cdk-tree-node *cdkTreeNodeDef="let node" [class.hidden]="!shouldRender(node)">
                <button
                    class="tree-node"
                    [class.nested]="node.path.length > 0"
                    (click)="log(node.name)"
                    [appTooltip]="label"
                    [tooltipOptions]="{ preferredPosition: 'right' }"
                >
                    <div class="indent-line" *ngFor="let line of range(node.path.length)">&nbsp;</div>

                    <div class="content">
                        <button
                            class="node-toggle"
                            cdkTreeNodeToggle
                            [attr.aria-label]="'Toggle ' + node.name"
                            (click)="node.isExpanded = !node.isExpanded"
                            [class.invisible]="!node.expandable"
                        >
                            <app-icon
                                iconClass="fas fa-chevron-right"
                                class="block transition-transform"
                                [class.rotate-90]="node.isExpanded"
                            ></app-icon>
                        </button>

                        <ng-template #label>
                            <app-entity-page-label
                                [title]="node.name"
                                [pageIcon]="node.entityType || EntityType.TASKLIST"
                            ></app-entity-page-label>
                        </ng-template>
                        <ng-container *ngTemplateOutlet="label"></ng-container>
                    </div>

                    <div class="btn-group">
                        <button class="" (click)="log('add stuff'); $event.stopPropagation()">
                            <app-icon iconClass="far fa-plus"></app-icon>
                        </button>
                        <button class="" (click)="log('ellipsieren'); $event.stopPropagation()">
                            <double-ellipsis-icon></double-ellipsis-icon>
                        </button>
                    </div>
                </button>
            </cdk-tree-node>
        </cdk-tree>
    </ng-container>

    <!-- MAIN HEADER -->
    <ng-container header>
        <!-- <div class="header-border | absolute bottom-0 h-[1px] w-full bg-tinted-800 transition-opacity" -->
        <!--     [class.opacity-0]="!isScrolled && !isSecondaryProgressBarVisible"></div> -->
        <div
            class="header-progress | absolute bottom-0 left-0 h-[2px] bg-submit-500 transition-opacity"
            [class.opacity-0]="!isSecondaryProgressBarVisible"
            [style.width]="progress + '%'"
        ></div>

        <!-- @TODO: Fix the header width issue (breadcrumbs taking more than allowed) -->
        <div class="breadcrumbs | flex w-full flex-wrap py-2 px-4 text-tinted-300" cdkMenuBar>
            <div *ngFor="let breadcrumb of breadcrumbs; let isLast = last" class="flex max-w-[80%]">
                <button
                    class="breadcrumb | menu-item | truncate py-0 px-1 hover:bg-tinted-800"
                    [class.text-tinted-100]="isLast"
                    appTooltip="Here will be more information"
                    cdkMenuItem
                >
                    <app-entity-page-label
                        *ngIf="breadcrumb.icon; else noIcon"
                        [title]="breadcrumb.text"
                        [pageIcon]="breadcrumb.icon"
                    ></app-entity-page-label>

                    <ng-template #noIcon>
                        <span class="truncate">{{ breadcrumb.text }}</span>
                    </ng-template>
                </button>
                <span class="seperator | mx-1 text-tinted-500" *ngIf="!isLast">/</span>
            </div>
        </div>

        <div cdkMenuBar>
            <button
                cdkMenuItem
                class="button-icon-naked menu-item | py-2 px-4"
                appTooltip="Here will be some options for the current open document"
            >
                <app-icon iconClass="fas fa-ellipsis-v"></app-icon>
            </button>
        </div>
    </ng-container>

    <!-- MAIN CONTENT -->
    <div class="mb-4">
        <!-- <div class="flex gap-1 text-tinted-300 opacity-0 transition-opacity group-hover:opacity-100"> -->
        <!--     <button class="button-naked">Add Sublist</button> -->
        <!--     <button class="button-naked">Add Description</button> -->
        <!-- </div> -->
        <!-- dont know 'bout these ones: -->
        <!-- <button class="button-naked">Add Task</button> -->
        <!-- <button class="button-naked">Share</button> -->

        <h1 class="heading | mt-4">
            <page-entity-icon class="mr-2.5 inline-block -translate-y-0.5 text-2xl" [icon]="TaskStatus.IN_PROGRESS">
            </page-entity-icon>

            <span class="title | outline-none" contenteditable>Taskname, which you can edit</span>
        </h1>

        <div class="description | text-tinted-300 outline-none" contenteditable>
            <p>And this is the part for the description</p>
            <p>Where you can</p>
            <ul>
                <li>Describe the list/task in further detail</li>
                <li>Take notes for yourself</li>
                <li>Quickly write down / sketch out ideas</li>
            </ul>
        </div>
    </div>

    <div
        class="progress-container | group sticky -top-3 z-30 mb-5 flex items-center gap-2 bg-tinted-900 pt-4 pb-3 shadow-header"
    >
        <div
            #progressBar
            class="progress | h-1.5 grow rounded bg-tinted-700 transition-colors group-hover:bg-tinted-600"
            appTooltip="{{ progress }}% closed - {{ closedTasks }}/{{ allTasks }}"
            [tooltipOptions]="{ closeOnHostClick: false }"
        >
            <div class="h-full rounded bg-submit-400 transition-shadow" [style.width]="progress + '%'"></div>
        </div>
        <button
            class="text-sm text-tinted-600 transition-colors group-hover:text-submit-400"
            (click)="isShownAsPercentage = !isShownAsPercentage"
        >
            {{ isShownAsPercentage ? progress + '%' : closedTasks + ' / ' + allTasks }}
        </button>
    </div>

    <app-tasks-demo></app-tasks-demo>
</app-sidebar-layout>
