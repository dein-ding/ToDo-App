<li
    *ngIf="task$ | async as task"
    class="task | relative flex w-full max-w-full list-none flex-col rounded-xl border border-tinted-700 border-opacity-75 bg-tinted-800 py-2 px-1 pb-1 shadow shadow-tinted-900 transition-colors duration-75"
    [ngClass]="{
        'completed border-submit-700 border-opacity-60 bg-submit-800 text-submit-200':
            task.status == TaskStatus.COMPLETED,
        titleHasFocus: inlineEditor.isFocused,
        isHovered,
        descriptionHasFocus: isDescriptionFocused$ | push
    }"
    [cdkContextMenuTriggerFor]="menu"
    (cdkContextMenuOpened)="isHovered = true"
    (cdkContextMenuClosed)="isHovered = false"
>
    <div class="mb-1 box-border flex items-center justify-between gap-2 px-2">
        <div class="max-w-[calc(100%-1.7rem)]">
            <div class="first-row | flex items-center">
                <button
                    class="status-btn | icon-btn | -ml-1 mr-2.5 text-lg"
                    [appTooltip]="statusTooltip"
                    [tooltipOptions]="{ avoidPositions: ['right'] }"
                    [cdkMenuTriggerFor]="statusMenu"
                    (cdkMenuOpened)="isHovered = true"
                    (cdkMenuClosed)="isHovered = false"
                    data-test-name="task-status-button"
                >
                    <ng-template #statusTooltip>
                        <span class="text-tinted-300 decoration-[3px]">Status: </span>
                        <span [class]="statusColorMap[task.status]">{{ task.status.replace('_', ' ') }}</span>
                    </ng-template>

                    <app-icon [icon]="loading || task.status"></app-icon>
                </button>
                <ng-template #statusMenu>
                    <app-drop-down
                        *ngIf="statusMenuItems$ | push as items"
                        [items]="items"
                        [data]="{ id: task.id }"
                    ></app-drop-down>
                </ng-template>

                <app-inline-editor
                    #inlineEditor
                    [textInput]="task.title"
                    [placeholder]="PLACEHOLDER"
                    [placeholderColor]="placeholderColorMap[task.status]"
                    [highlight]="highlightQuery$ | push"
                    [editorClass]="{
                        'line-through': task.status == TaskStatus.NOT_PLANNED,
                        'decoration-danger-400': task.status == TaskStatus.NOT_PLANNED,
                        'decoration-[3px]': task.status == TaskStatus.NOT_PLANNED,
                        'pr-12': true
                    }"
                    [enableDebouncedUpdates]="false"
                    (update)="titleChange.emit($event || '')"
                    [readonly]="readonly"
                    data-test-name="task-title"
                ></app-inline-editor>
            </div>

            <div
                class="second-row | ml-0.5 flex flex-wrap gap-2"
                [class.mt-1]="(nodeData$ | async)?.hasChildren || task.description || (isDescriptionExpanded$ | async)"
            >
                <ng-container *ngIf="nodeData$ | async as nodeData">
                    <ng-container *ngIf="nodeData.hasChildren">
                        <button
                            class="subtask-toggle"
                            (click)="expansionChange.emit(!nodeData.isExpanded)"
                            data-test-name="subtask-toggle"
                        >
                            <app-icon
                                icon="chevronRight"
                                class="mr-1 inline-block transition-transform"
                                [class.rotate-90]="nodeData.isExpanded"
                            ></app-icon>
                            {{ task.childrenCount }} Subtask{{ task.childrenCount == 1 ? '' : 's' }}
                        </button>

                        <div *ngIf="task.description || (isDescriptionExpanded$ | async)" class="separator"></div>
                    </ng-container>

                    <ng-container *ngIf="task.description || (isDescriptionExpanded$ | async)">
                        <button class="description-toggle" (click)="toggleDescription()">
                            <app-icon
                                icon="chevronRight"
                                class="mr-1 inline-block transition-transform"
                                [class.rotate-90]="isDescriptionExpanded$ | async"
                            ></app-icon>
                            <!-- <app-icon icon="description" class="mx-1"></app-icon> -->
                            Description
                        </button>
                        <!-- <button class="expand-description">
                            <app-icon icon="expand"></app-icon>
                        </button> -->
                    </ng-container>
                </ng-container>
            </div>
        </div>
        <div class="relative -mr-1 max-w-max">
            <div class="icon-group | flex max-w-max flex-wrap items-center justify-end gap-3 transition-transform">
                <app-icon
                    *ngIf="isOverdue"
                    class="overdue-icon | animate-ping"
                    icon="fas fa-exclamation-triangle text-danger-400"
                    data-test-name="overdue-icon"
                ></app-icon>

                <ng-container
                    *ngIf="
                        task.status != TaskStatus.COMPLETED &&
                        task.status != TaskStatus.NOT_PLANNED &&
                        task.priority != TaskPriority.NONE
                    "
                >
                    <ng-container *ngTemplateOutlet="priorityButton"></ng-container>
                </ng-container>
            </div>
            <button
                class="| icon-btn | absolute top-[50%] right-0 translate-y-[-50%] text-tinted-200 transition-opacity"
                [cdkMenuTriggerFor]="menu"
                (cdkMenuOpened)="isHovered = true"
                (cdkMenuClosed)="isHovered = false"
                #trigger="cdkMenuTriggerFor"
                data-test-name="task-menu-button"
            >
                <double-ellipsis-icon></double-ellipsis-icon>
            </button>

            <ng-template #menu>
                <app-drop-down
                    *ngIf="menuItems$ | push as items"
                    [items]="items"
                    [rootTrigger]="trigger"
                    [data]="{ id: task.id, entityType: EntityType.TASK }"
                ></app-drop-down>
            </ng-template>
        </div>
    </div>

    <ng-template #priorityButton>
        <button
            class="priority-button | icon-btn keep-editor-focus"
            [appTooltip]="priorityTooltip"
            [tooltipOptions]="{ avoidPositions: ['left'] }"
            [cdkMenuTriggerFor]="priorityMenu"
            (cdkMenuOpened)="isHovered = true"
            (cdkMenuClosed)="isHovered = false"
            data-test-name="task-priority-button"
        >
            <app-icon [icon]="task.priority"></app-icon>
        </button>
    </ng-template>
    <ng-template #priorityTooltip>
        <span class="text-tinted-300">Priority: </span>
        <span>{{ task.priority }}</span>
    </ng-template>
    <ng-template #priorityMenu>
        <app-drop-down
            *ngIf="priorityMenuItems$ | push as items"
            [items]="items"
            [data]="{ id: task.id }"
        ></app-drop-down>
    </ng-template>

    <ng-container
        *rxLet="{ isExpanded: isDescriptionExpanded$ | push, isFocused: isDescriptionFocused$ | push }; let props"
    >
        <!-- <div [class.relative]="descriptionEditor.isFocused$ | push"> -->
        <div *ngIf="props.isExpanded || props.isFocused" [class.relative]="false">
            <div class="absolute inset-x-0 bottom-[calc(100%-.5rem)] z-20 flex justify-center px-4">
                <!-- <app-toolbar [hide]="!inlineEditor.isFocused && !(descriptionEditor.isFocused$ | push)"> -->
                <app-toolbar [hide]="!props.isFocused">
                    <!-- <button class="button-m">Cancel</button>
                        <button class="button-m button--submit">Create</button>
                        <div class="toolbar-separator"></div> -->
                    <!-- <div class="toolbar-separator"></div> -->
                    <!-- <ng-container *ngTemplateOutlet="priorityButton"></ng-container> -->
                    <a
                        class="open-as-page | skip-default-a-styles keep-editor-focus | icon-btn"
                        appTooltip="Open task as page"
                        routerLink="/home/{{ task.id }}"
                        (click)="descriptionEditor.editor.commands.blur()"
                    >
                        <app-icon icon="expand"></app-icon>
                    </a>

                    <!-- <ng-container *ngIf="props.isFocused"> -->
                    <div class="toolbar-separator"></div>
                    <app-rt-editor-toolbar [editor]="descriptionEditor.editor"></app-rt-editor-toolbar>
                    <!-- </ng-container> -->
                </app-toolbar>
            </div>
            <app-rt-editor
                #descriptionEditor
                class="description | mt-1 max-h-72 overflow-y-auto rounded-lg bg-tinted-900 py-1.5 px-2.5 ring-2 ring-transparent transition-colors duration-75"
                [ngClass]="{
                    'hasFocus !ring-primary-400': props.isFocused
                }"
                [value]="task.description ?? ''"
                placeholder="Description or notes"
                (contentChanges)="descriptionChanges$.next($event)"
                (isFocused)="isDescriptionFocused$.next($event)"
                (blur)="descriptionBlurEvents$.next(null)"
                data-test-name="task-description"
            ></app-rt-editor>
        </div>
    </ng-container>
</li>
