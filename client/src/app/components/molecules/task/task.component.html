<div class="task-wrapper">
    <!-- <div
        *ngIf="data.meta.notes && !isDetailsPopOutOpen"
        class="pop-out-collapsed"
        (click)="toggleDetailsPopOutOpen(); $event.stopPropagation()"
    ></div> -->
    <div #popOutContainer *ngIf="isDetailsPopOutOpen" class="pop-out-container">
        <div
            #notesBlock
            class="notesBlock input dimm-0"
            [innerHTML]="this.data.meta.notes"
            [contentEditable]="!isCompleted"
            [spellcheck]="isNotesBlockFocused"
            (textChanges)="updatedNotes = $event"
            [domChangesOptions]="{ plainOnly: false, observe: isNotesBlockFocused }"
            (keydown)="notesBlockKeydownHandler($event)"
            (focus)="isNotesBlockFocused = true"
            [class.is-focused]="isNotesBlockFocused"
            (document:click)="notesBlockOutsideClickHandler($event)"
        ></div>
        <div class="position-pop-out-actions">
            <div class="pop-out-actions-container">
                <button
                    class="pop-out-action no-filter"
                    title="open task details"
                    (click)="openDetails(!data.isCompleted, 'notes')"
                >
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <button
                    class="pop-out-action"
                    [class.primary-clr]="uiState.detailsPopOut.keepOpen"
                    [class.no-filter]="!uiState.detailsPopOut.keepOpen"
                    title="{{ uiState.detailsPopOut.keepOpen ? 'DON\'T keep details open' : 'keep details open' }}"
                    (click)="setKeepDetailsPopOutOpen(!uiState.detailsPopOut.keepOpen)"
                >
                    <i *ngIf="uiState.detailsPopOut.keepOpen" class="far fa-lock-alt"></i>
                    <i *ngIf="!uiState.detailsPopOut.keepOpen" class="far fa-lock-open-alt"></i>
                </button>
                <button
                    *ngIf="updatedNotes != data.meta.notes"
                    class="pop-out-action danger-clr"
                    title="revert changes"
                    style="transform: scaleX(-1) rotate(40deg)"
                    (click)="resetNotesBlock()"
                >
                    <i class="fas fa-share"></i>
                </button>
                <button
                    class="pop-out-action"
                    title="{{ updatedNotes != data.meta.notes ? 'save changes & ' : '' }}close"
                    [class.submit-clr]="updatedNotes != data.meta.notes"
                    [class.no-filter]="updatedNotes == data.meta.notes"
                    (click)="toggleDetailsPopOutOpen()"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    <li
        id="task-{{ this.data.id }}"
        class="task"
        [class.touchDevice]="isTouchDevice"
        [class.completed]="this.isCompleted && this.data.isCompleted"
        [class.completed-transition]="this.isCompleted"
        [class.is-focused]="isFocused"
        [class.highlight-border]="this.isViewingDetails || isFocused || this.isCompleted || this.isDeleting"
        style="--border-clr: var(--{{ this.isDeleting ? 'danger' : this.isCompleted ? 'submit' : 'primary' }}-clr);"
        [class.alt-bg]="this.taskPosition % 2 == 1"
    >
        <div class="position-completed-at">
            <span *ngIf="this.data.isCompleted" class="completed-at">
                {{ formattedCompletionDate }}
            </span>
        </div>
        <div class="wrapper outer-wrapper">
            <div class="wrapper inner-wrapper">
                <button
                    class="btn btn-icon btn-complete"
                    title="mark task as {{ this.data.isCompleted ? 'un' : '' }}completed"
                    (click)="toggleCompleted()"
                    (mouseenter)="isCompleteBtnHovered = true"
                    (mouseleave)="isCompleteBtnHovered = false"
                >
                    <i
                        *ngIf="this.data.isCompleted; else uncompleted"
                        class="{{ isCompleteBtnHovered ? 'far fa-circle' : 'fas fa-check-circle' }}"
                    ></i>
                    <ng-template #uncompleted
                        ><i class="{{ isCompleteBtnHovered ? 'fas fa-check-circle' : 'far fa-circle' }}"></i>
                    </ng-template>
                </button>

                <div class="text-container">
                    <ng-template #detailIcons>
                        <span #detailIconsWrapper class="detail-icons-wrapper">
                            <span
                                *ngIf="!data.isCompleted || this.data.meta.notes"
                                class="detail-icon notes-icon"
                                [class.grayscale]="!isDetailsPopOutOpen"
                                [class.reveal]="!this.data.meta.notes && !isDetailsPopOutOpen"
                                title="toggle pop-out notes"
                                (click)="toggleDetailsPopOutOpen()"
                            >
                                <i class="fa{{ this.data.meta.notes ? 's' : 'r' }} fa-comment-alt-lines"></i>
                                <!-- <i class="fa{{ this.data.meta.notes ? 's' : 'r' }} fa-memo-circle-info"></i> -->
                            </span>
                            <span
                                *ngIf="this.data.meta.links.length"
                                [title]="this.data.meta.links.join('\n')"
                                class="detail-icon grayscale"
                                (click)="openDetails(!data.isCompleted, 'links')"
                            >
                                <i class="far fa-external-link-alt"></i>
                                <i class="fas fa-caret-down" style="margin-left: 0.175em"></i>
                            </span>
                        </span>
                    </ng-template>
                    <p>
                        <span
                            *ngIf="!isCompleted"
                            class="position-priority-icon"
                            [class.reveal-on-hover]="data.priority == 0 && !isFocused"
                        >
                            <priority-icon
                                [priority]="data.priority"
                                [showDropDown]="!isTouchDevice"
                                (change)="setPriority($event)"
                            ></priority-icon>
                        </span>

                        <!-- <span>
                            <template [ngTemplateOutlet]="detailIcons"></template>
                        </span> -->

                        <span
                            #taskName
                            class="taskName"
                            [contentEditable]="!isCompleted"
                            [spellcheck]="isFocused"
                            (textChanges)="updatedTaskName = $event"
                            [domChangesOptions]="{ plainOnly: true, observe: isFocused }"
                            (keydown.Enter)="taskName.blur()"
                            (keydown.Escape)="
                                updatedTaskName = data.name; taskName.innerText = data.name; taskName.blur()
                            "
                            (focus)="isFocused = true; updatedTaskName = data.name"
                            (blur)="isFocused = false; updateTaskName()"
                            >{{ this.data.name }}</span
                        >

                        <span *ngIf="!data.subTasks.length" class="first-row-detailIcons">
                            <template [ngTemplateOutlet]="detailIcons"></template>
                        </span>
                    </p>
                    <div class="second-row">
                        <p *ngIf="this.data.subTasks.length" class="subtask-list-toggle">
                            <collapse-toggle
                                [isOpen]="!uiState.collapseSubtaskList"
                                noSpacing
                                hideToggleText
                                dimm="none"
                                (onToggle)="toggleCollapseSubtaskList()"
                            >
                                <span
                                    *ngIf="openTasksCount; else completed"
                                    class="text-shadow"
                                    style="color: var(--secondary-clr)"
                                >
                                    {{ openTasksCount }} open
                                </span>
                                <ng-template #completed>
                                    <span style="color: var(--submit-clr)"> {{ completedTasksCount }} completed </span>
                                </ng-template>
                                <span class="dimm-1">
                                    {{ completedTasksCount && openTasksCount ? "/ " + this.data.subTasks.length : "" }}
                                    {{ this.data.subTasks.length == 1 ? "subtask" : "subtasks" }}
                                </span>
                            </collapse-toggle>
                        </p>
                        <template *ngIf="data.subTasks.length" [ngTemplateOutlet]="detailIcons"></template>
                    </div>
                </div>
            </div>
            <ng-template #taskActionBtns>
                <button
                    title="add sub task"
                    class="btn btn-icon btn-secondary"
                    [class.disabled]="this.data.isCompleted"
                    (click)="addSubTask(); setIsTaskActionBtnsMenuOpenOnTouchDevice(false)"
                    style="--btn-index: 2; --btn-index-reverse: 0"
                >
                    <i class="fas fa-plus"></i></button
                ><button
                    title="open task details"
                    class="btn btn-icon btn-edit"
                    (click)="openDetails(!data.isCompleted); setIsTaskActionBtnsMenuOpenOnTouchDevice(false)"
                    style="--btn-index: 1; --btn-index-reverse: 1"
                >
                    <i class="fas fa-ellipsis-v"></i></button
                ><button
                    title="delete task"
                    class="btn btn-icon btn-delete"
                    (click)="deleteTask(); setIsTaskActionBtnsMenuOpenOnTouchDevice(false)"
                    style="--btn-index: 0; --btn-index-reverse: 2"
                >
                    <i class="far fa-trash-alt"></i>
                </button>
            </ng-template>
            <div *ngIf="!isTouchDevice" class="position-task-action-btns">
                <div class="btn-group">
                    <template [ngTemplateOutlet]="taskActionBtns"></template>
                </div>
            </div>
            <menu-toggle-btn
                *ngIf="isTouchDevice"
                [isOpen]="isTaskActionBtnsMenuOpenOnTouchDevice"
                (onMenuToggle)="setIsTaskActionBtnsMenuOpenOnTouchDevice($event)"
            >
                <template [ngTemplateOutlet]="taskActionBtns"></template>
            </menu-toggle-btn>
        </div>
        <div class="position-task-progress">
            <task-progress
                [tasksCount]="data.subTasks.length"
                [completedTasksCount]="completedTasksCount"
                [openTasksCount]="openTasksCount"
            ></task-progress>
        </div>
    </li>
</div>

<task-list
    *ngIf="this.data.subTasks.length && !uiState.collapseSubtaskList"
    variant="subtask"
    [tasklist]="data.subTasks"
    [id]="data.id"
    [taskPosition]="taskPosition"
    [collapseCompletedTasks]="uiState.collapseCompletedSubtasks"
    [isCompleted]="isCompleted"
    [focusChangeEvents]="quickAddInputFocusEventSubject"
    (onAddSubtask)="addSubTask($event)"
    (onToggleCollapseCompleted)="toggleCollapseCompletedSubtasks()"
    (completion)="onSubtaskCompletion($event)"
></task-list>
