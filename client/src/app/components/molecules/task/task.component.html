<li
    id="task-{{ this.data.id }}"
    class="task"
    [class.touchDevice]="isTouchDevice"
    [class.completed]="this.isCompleted && this.data.isCompleted"
    [class.completed-transition]="this.isCompleted"
    [class.alt-bg]="this.taskPosition % 2 == 1"
>
    <div class="position-time-completed">
        <span *ngIf="this.data.isCompleted" class="time-completed">
            {{ formatDateRelative(this.data.completedAt) }}
        </span>
    </div>
    <div class="wrapper outer-wrapper">
        <div class="wrapper inner-wrapper">
            <button
                class="btn btn-icon btn-complete"
                title="mark task as {{ this.data.isCompleted ? 'un' : '' }}completed"
                (click)="toggleCompleted()"
                (mouseenter)="completeBtnIsHovered = true"
                (mouseleave)="completeBtnIsHovered = false"
            >
                <i
                    *ngIf="this.data.isCompleted; else uncompleted"
                    class="{{ completeBtnIsHovered ? 'far fa-circle' : 'fas fa-check-circle' }}"
                ></i>
                <ng-template #uncompleted
                    ><i class="{{ completeBtnIsHovered ? 'fas fa-check-circle' : 'far fa-circle' }}"></i>
                </ng-template>
            </button>

            <div class="text-container">
                <p>
                    <priority-icon [priority]="data.priority"></priority-icon>
                    <span class="taskName">
                        {{ this.data.name }}
                    </span>
                </p>
                <div class="second-row">
                    <p *ngIf="this.data.subTasks.length != 0" class="subtask-list-toggle">
                        <collapse-toggle
                            [isOpen]="!this.data.collapseSubtaskList"
                            noSpacing
                            hideToggleText
                            dimm="none"
                            (onToggle)="toggleSubtaskList()"
                        >
                            <span *ngIf="countOpenTasks(this.data.subTasks) != 0">
                                <span style="color: var(--secondary-clr)">
                                    {{ countOpenTasks(this.data.subTasks) }} open</span
                                >
                                <span class="dimm-1"> /</span>
                            </span>
                            <span class="dimm-1">
                                {{ this.data.subTasks.length }}
                                {{ this.data.subTasks.length == 1 ? "subtask" : "subtasks" }}
                            </span>
                        </collapse-toggle>
                    </p>
                    <span *ngIf="this.data.meta.notes || this.data.meta.links.length" class="detail-icons-wrapper">
                        <span
                            *ngIf="this.data.meta.notes"
                            class="detail-icon"
                            style="position: relative; top: 2px"
                            [title]="this.data.meta.notes"
                            (click)="data.isCompleted ? showDetails('notes') : editTaskDetails('notes')"
                        >
                            <i class="far fa-comment-alt-lines"></i>
                        </span>
                        <span
                            *ngIf="this.data.meta.links.length"
                            [title]="this.data.meta.links.join('\n')"
                            class="detail-icon"
                            (click)="data.isCompleted ? showDetails('links') : editTaskDetails('links')"
                        >
                            <i class="far fa-external-link-alt"></i>
                            <i class="fas fa-caret-down" style="margin-left: 0.175em"></i>
                        </span>
                    </span>
                </div>
            </div>
        </div>
        <ng-template #taskActionBtns>
            <button
                title="add sub task"
                class="btn btn-icon btn-secondary"
                [class.disabled]="this.data.isCompleted"
                (click)="addSubTask(); toggleTaskActionBtns(false)"
                style="--btn-index: 2; --btn-index-reverse: 0"
            >
                <i class="fas fa-plus"></i></button
            ><button
                title="show{{ this.data.isCompleted ? '' : '/edit' }} task details"
                class="btn btn-icon btn-edit"
                (click)="data.isCompleted ? showDetails() : editTaskDetails(); toggleTaskActionBtns(false)"
                style="--btn-index: 1; --btn-index-reverse: 1"
            >
                <!-- [class.disabled]="this.data.isCompleted" -->
                <!-- <i class="fas fa-info"></i> -->
                <i class="fas fa-ellipsis-v"></i></button
            ><button
                title="delete task"
                class="btn btn-icon btn-delete"
                (click)="deleteTask(this.data.id); toggleTaskActionBtns(false)"
                style="--btn-index: 0; --btn-index-reverse: 2"
            >
                <i class="far fa-trash-alt"></i>
            </button>
        </ng-template>
        <div *ngIf="!isTouchDevice" class="position-task-action-btns">
            <div class="btn-group">
                <template [ngTemplateOutlet]="taskActionBtns"></template>
            </div>
        </div>
        <menu-toggle-btn
            *ngIf="isTouchDevice"
            [isOpen]="touchDevice_showBtns"
            (onMenuToggle)="toggleTaskActionBtns($event)"
        >
            <template [ngTemplateOutlet]="taskActionBtns"></template>
        </menu-toggle-btn>
    </div>
</li>

<ul
    *ngIf="this.data.subTasks.length != 0"
    class="subtask-list subtask-list-{{ this.data.id }}"
    [class.hide]="this.data.collapseSubtaskList"
>
    <task
        *ngFor="let task of this.uncompletedTasks; let i = index"
        [data]="task"
        [showCompleted]="showCompleted"
        [taskPosition]="this.taskPosition + i - 1"
    ></task>

    <single-input-form
        *ngIf="this.data.subTasks.length != 0 && !this.data.collapseSubtaskList && !data.isCompleted"
        (onSubmit)="addSubTask($event)"
        [inputFieldId]="'_' + data.id"
    ></single-input-form>

    <collapse-toggle
        *ngIf="completedTasks.length && uncompletedTasks.length"
        [isOpen]="showCompleted"
        (onToggle)="showCompleted = $event"
        colorClass="btn-submit"
        dimm="dimm-1"
        >{{ completedTasks.length }} completed task{{ completedTasks.length > 1 ? "s" : "" }}</collapse-toggle
    >
    <div *ngIf="showCompleted || !uncompletedTasks.length">
        <task
            *ngFor="let task of this.completedTasks; let i = index"
            [data]="task"
            [showCompleted]="showCompleted"
            [taskPosition]="this.taskPosition + i + 1 + this.uncompletedTasks.length"
        ></task>
    </div>
</ul>
